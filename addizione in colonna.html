<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Addizioni</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Comic Sans MS', 'Chalkboard SE', cursive;
        }
        
        body {
            background: linear-gradient(to bottom, #87cefa, #add8e6);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        
        .game-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 100, 0.2);
            padding: 15px;
            width: 100%;
            max-width: 800px;
            text-align: center;
            border: 3px solid #4a90e2;
            position: relative;
        }
        
        .game-header {
            margin-bottom: 10px;
        }
        
        h1 {
            color: #ff6b00;
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .game-info {
            display: flex;
            justify-content: space-around;
            background: #e6f7ff;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 2px solid #4a90e2;
        }
        
        .punteggio, .vite, .istruzioni-btn {
            font-size: 0.9rem;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .punteggio { 
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }
        .vite { 
            background: #ffe6e6;
            color: #dc3545;
            border: 2px solid #dc3545;
        }
        .istruzioni-btn { 
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
            transition: all 0.2s;
        }
        
        .istruzioni-btn:hover {
            background: #ffeaa7;
            transform: translateY(-1px);
        }
        
        .modalita-selezione {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .bottone-modalita {
            padding: 8px 15px;
            border: 2px solid #4a90e2;
            border-radius: 6px;
            background: #e6f7ff;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bottone-modalita:hover {
            background: #b3e0ff;
        }
        
        .bottone-modalita.attiva {
            background: #4a90e2;
            color: white;
            font-weight: bold;
        }
        
        .sezione-colonna {
            background: #f0f8ff;
            border: 2px solid #4a90e2;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .colonna-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin: 0 auto;
            max-width: 280px;
        }
        
        .riga-colonna {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin: 3px 0;
            width: 100%;
        }
        
        .riga-riporti {
            margin-bottom: 5px;
            min-height: 35px;
        }
        
        .cella-riporto {
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid #228b22;
            border-radius: 6px;
            background: #90ee90;
            font-size: 1.2rem;
            font-weight: bold;
            color: #006400;
            margin-left: 5px;
            cursor: pointer;
        }
        
        .cella-riporto.attivo {
            background: #c8f7c5;
            border: 2px solid #28a745;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .spazio-segno {
            width: 25px;
            margin-right: 5px;
            font-size: 1.3rem;
            font-weight: bold;
        }
        
        .cella-numero {
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid #4a90e2;
            margin-left: 5px;
            font-size: 1.2rem;
            font-weight: bold;
            background: white;
            border-radius: 6px;
        }
        
        .cella-virgola {
            width: 15px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.4rem;
            font-weight: bold;
            margin-left: 2px;
            margin-right: 2px;
        }
        
        .cella-risultato {
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid #4a90e2;
            margin-left: 5px;
            font-size: 1.2rem;
            font-weight: bold;
            background: #e6f7ff;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cella-risultato:hover {
            background: #b3e0ff;
        }
        
        .cella-evidenziata {
            animation: evidenzia 1s infinite;
            border: 2px solid #ffa500;
            background: #fffacd;
        }
        
        @keyframes evidenzia {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .cella-corretta {
            background: #c8f7c5;
            border: 2px solid #28a745;
        }
        
        .cella-errata {
            background: #ffcccc;
            border: 2px solid #dc3545;
        }
        
        /* LINEA NERA - RIMESSA, LUNGHEZZA UGUALI ALLE CASELLE */
        .linea-divisione {
            border-top: 2px solid #000;
            margin: 5px 0;
            width: calc(35px * 5 + 5px * 4); /* 5 caselle da 35px + 4 margini da 5px */
            align-self: flex-end;
        }
        
        /* MESSAGGIO DI VERIFICA DENTRO LO SCHERMO */
        .messaggio-verifica {
            background: #fff3cd;
            border: 2px dashed #ffc107;
            border-radius: 6px;
            padding: 10px 15px;
            margin: 15px auto 0 auto;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 280px;
            font-weight: bold;
            font-size: 0.95rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }
        
        .messaggio-verifica.mostra {
            opacity: 1;
            transform: translateY(0);
        }
        
        .messaggio-corretto {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        .messaggio-errato {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        
        .messaggio-info {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        
        .messaggio-game-over {
            background: #6c757d;
            border-color: #495057;
            color: white;
            font-size: 1.1rem;
            padding: 15px;
        }
        
        .controlli {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .bottone {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: #4a90e2;
            color: white;
            transition: all 0.2s;
            min-width: 100px;
        }
        
        .bottone:hover {
            background: #357ae8;
        }
        
        .bottone-verifica {
            background: #28a745;
        }
        
        .bottone-aiuto {
            background: #ffa500;
        }
        
        .bottone-nuova {
            background: #9370db;
        }
        
        .tastiera-container {
            background: #e6f7ff;
            border-radius: 8px;
            padding: 10px;
            border: 2px solid #4a90e2;
        }
        
        .tastiera-numerica {
            display: flex;
            justify-content: center;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .tasto-numero {
            width: 45px;
            height: 45px;
            font-size: 1.2rem;
            font-weight: bold;
            border: 2px solid #4a90e2;
            border-radius: 6px;
            background: #b3e0ff;
            cursor: pointer;
            color: #000080;
        }
        
        .tasto-numero:hover {
            background: #87cefa;
        }
        
        .tasto-cancella {
            background: #ff6b6b;
            color: white;
            border-color: #dc3545;
            font-size: 1rem;
            width: 70px;
        }
        
        /* MODALE ISTRUZIONI */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border: 3px solid #4a90e2;
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #4a90e2;
            padding-bottom: 10px;
        }
        
        .modal-title {
            color: #ff6b00;
            font-size: 1.3rem;
        }
        
        .close-modal {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .modal-section {
            margin-bottom: 15px;
            text-align: left;
        }
        
        .modal-section h3 {
            color: #4a90e2;
            margin-bottom: 8px;
            font-size: 1.1rem;
            border-left: 4px solid #ffa500;
            padding-left: 8px;
        }
        
        .modal-section p {
            margin-bottom: 8px;
            line-height: 1.4;
            font-size: 0.9rem;
        }
        
        .modal-list {
            list-style-type: decimal;
            padding-left: 20px;
            margin: 10px 0;
        }
        
        .modal-list li {
            margin-bottom: 8px;
            line-height: 1.4;
            font-size: 0.9rem;
        }
        
        .punteggio-info {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .punteggio-item {
            background: #e6f7ff;
            padding: 8px;
            border-radius: 6px;
            border: 2px solid #4a90e2;
            flex: 1;
            min-width: 120px;
        }
        
        .punteggio-item .value {
            font-weight: bold;
            color: #28a745;
            font-size: 1.1rem;
        }
        
        /* Indicatore risposte consecutive */
        .risposte-consecutive {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
            font-size: 0.8rem;
            color: #4a90e2;
            font-weight: bold;
        }
        
        .cuore-consecutivo {
            color: #dc3545;
            font-size: 1rem;
        }
        
        /* Indicatore aiuti utilizzati */
        .aiuti-utilizzati {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
            font-size: 0.8rem;
            color: #856404;
            font-weight: bold;
        }
        
        .icona-aiuto {
            color: #ffa500;
            font-size: 1rem;
        }
    </style>
</head>
<body onload="inizializzaGioco()">
    <div class="game-container">
        <div class="game-header">
            <h1>GIOCA CON LE ADDIZIONI</h1>
            
            <div class="modalita-selezione">
                <button class="bottone-modalita attiva" onclick="cambiaModalita('interi')">
                    Interi
                </button>
                <button class="bottone-modalita" onclick="cambiaModalita('decimali')">
                    Decimali
                </button>
            </div>
            
            <div class="game-info">
                <div class="punteggio">üåü <span id="punteggio">0</span> punti</div>
                <div class="vite">‚ù§Ô∏è <span id="vite">3</span> vite</div>
                <div class="istruzioni-btn" onclick="mostraIstruzioni()" title="Istruzioni del gioco">
                    üìö Istruzioni
                </div>
            </div>
            
            <!-- Indicatore risposte consecutive corrette -->
            <div class="risposte-consecutive" id="risposte-consecutive">
                <span>Risposte consecutive corrette:</span>
                <span id="contatore-consecutive">0</span>
                <span class="cuore-consecutivo">‚ù§Ô∏è</span>
            </div>
            
            <!-- Indicatore aiuti utilizzati in questa operazione -->
            <div class="aiuti-utilizzati" id="aiuti-utilizzati">
                <span>Aiuti utilizzati in questa operazione:</span>
                <span id="contatore-aiuti">0</span>
                <span class="icona-aiuto">üß†</span>
                <span>(costo: -2 punti ciascuno)</span>
            </div>
        </div>
        
        <div class="sezione-colonna">
            <div class="colonna-container" id="colonna-container">
                <!-- Contenuto generato dinamicamente -->
            </div>
            
            <!-- MESSAGGIO DI VERIFICA -->
            <div class="messaggio-verifica" id="messaggio-verifica"></div>
        </div>
        
        <div class="controlli">
            <button class="bottone bottone-aiuto" onclick="mostraAiuto()" id="bottone-aiuto">
                üß† Aiuto (-2 punti)
            </button>
            <button class="bottone bottone-verifica" onclick="verificaOperazione()" id="bottone-verifica">
                ‚úì Verifica
            </button>
            <button class="bottone bottone-nuova" onclick="nuovaOperazione()">
                üîÑ Nuova
            </button>
        </div>
        
        <div class="tastiera-container">
            <div class="tastiera-numerica" id="tastiera-numerica">
                <!-- Tastiera generata dinamicamente -->
            </div>
        </div>
    </div>

    <!-- MODALE ISTRUZIONI -->
    <div class="modal-overlay" id="modal-overlay" onclick="nascondiIstruzioni(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">
                    üêõ Istruzioni del Gioco
                </div>
                <button class="close-modal" onclick="nascondiIstruzioni()">‚úï</button>
            </div>
            
            <div class="modal-section">
                <h3>üéØ Come Giocare</h3>
                <p>Risolvi le addizioni in colonna:</p>
                <ol class="modal-list">
                    <li>Inizia dalla colonna pi√π a destra (unit√†)</li>
                    <li>Clicca sulla casella gialla del risultato</li>
                    <li>Inserisci la cifra con la tastiera</li>
                    <li>Se la somma √® 10 o pi√π, inserisci il riporto (1) nella casella verde</li>
                    <li>Procedi verso sinistra</li>
                    <li>Premi "Verifica" per controllare</li>
                </ol>
            </div>
            
            <div class="modal-section">
                <h3>üèÜ Sistema dei Punteggi e Vite</h3>
                <div class="punteggio-info">
                    <div class="punteggio-item">
                        <div>Operazione completata:</div>
                        <div class="value">Max punti = numero di cifre</div>
                    </div>
                    <div class="punteggio-item">
                        <div>Aiuto utilizzato:</div>
                        <div class="value">-2 punti ciascuno</div>
                    </div>
                    <div class="punteggio-item">
                        <div>Errore:</div>
                        <div class="value">-1 vita</div>
                    </div>
                    <div class="punteggio-item">
                        <div>5 risposte corrette consecutive:</div>
                        <div class="value">+1 vita</div>
                    </div>
                </div>
                <p><strong>üìä Punteggio per operazione:</strong></p>
                <ul class="modal-list">
                    <li><strong>2 cifre</strong>: Massimo 2 punti</li>
                    <li><strong>3 cifre</strong>: Massimo 3 punti</li>
                    <li><strong>4 cifre</strong>: Massimo 4 punti</li>
                    <li><strong>5 cifre</strong>: Massimo 5 punti</li>
                </ul>
                <p><strong>‚ö†Ô∏è Attenzione:</strong> Se usi troppi aiuti, potresti finire con 0 punti per quell'operazione!</p>
                <p><strong>‚ú® Bonus Vita:</strong> Ogni 5 risposte consecutive corrette, recuperi una vita (massimo 3 vite).</p>
            </div>
            
            <div class="modal-section">
                <h3>üìö Modalit√† di Gioco</h3>
                <p><strong>Numeri Interi:</strong> Addizioni senza virgola (max 5 cifre)</p>
                <p><strong>Numeri Decimali:</strong> Addizioni con virgola (2 decimali)</p>
            </div>
        </div>
    </div>

    <script>
        // VARIABILI DEL GIOCO
        let punteggio = 0;
        let vite = 3;
        let numero1 = 0;
        let numero2 = 0;
        let risultatoCorretto = 0;
        let modalitaGioco = 'interi';
        let verificaEseguita = false;
        let gameOver = false;
        let haSbagliatoQuestaOperazione = false;
        
        // VARIABILI PER IL RECUPERO VITE
        let operazioniCorretteConsecutive = 0;
        
        // VARIABILI PER IL PUNTEGGIO DINAMICO
        let aiutiUtilizzatiOperazioneCorrente = 0;
        let punteggioBaseOperazioneCorrente = 0; // Dipende dal numero di cifre
        let numeroCifreOperazioneCorrente = 0;
        
        let numCifreTotali = 0;
        let colonnaAttiva = 0;
        let cifreNumero1 = [];
        let cifreNumero2 = [];
        let cifreRisultato = [];
        let cifreRiporto = [];
        let risultatiCorretti = [];
        let riportiCorretti = [];
        let modalitaRiporto = false;
        let posizioneVirgola = 0;

        // FUNZIONE PER GENERARE NUMERI CASUALI MIGLIORI - VERSIONE SEMPLIFICATA
        function generaNumeroCasuale(cifre) {
            cifre = Math.min(cifre, 5);
            const min = Math.pow(10, cifre - 1);
            const max = Math.pow(10, cifre) - 1;
            let numero = Math.floor(Math.random() * (max - min + 1)) + min;
            return numero;
        }

        // FUNZIONE PER GENERARE NUMERI DECIMALI CASUALI
        function generaNumeroDecimale() {
            const cifreIntere = Math.floor(Math.random() * 3) + 1;
            const parteIntera = generaNumeroCasuale(cifreIntere);
            const decimale = Math.floor(Math.random() * 100);
            return parseFloat(`${parteIntera}.${decimale.toString().padStart(2, '0')}`);
        }

        // INIZIALIZZAZIONE
        function inizializzaGioco() {
            punteggio = 0;
            vite = 3;
            gameOver = false;
            haSbagliatoQuestaOperazione = false;
            operazioniCorretteConsecutive = 0; // Reset contatore
            aiutiUtilizzatiOperazioneCorrente = 0; // Reset aiuti
            modalitaGioco = 'interi';
            verificaEseguita = false;
            aggiornaUI();
            creaTastiera();
            nuovaOperazione();
            
            document.getElementById("bottone-verifica").disabled = false;
            document.getElementById("bottone-aiuto").disabled = false;
        }

        function cambiaModalita(nuovaModalita) {
            if (gameOver) return;
            
            modalitaGioco = nuovaModalita;
            verificaEseguita = false;
            haSbagliatoQuestaOperazione = false;
            aiutiUtilizzatiOperazioneCorrente = 0; // Reset aiuti
            
            document.querySelectorAll('.bottone-modalita').forEach(btn => {
                btn.classList.remove('attiva');
                if ((nuovaModalita === 'interi' && btn.textContent.includes('Interi')) || 
                    (nuovaModalita === 'decimali' && btn.textContent.includes('Decimali'))) {
                    btn.classList.add('attiva');
                }
            });
            
            nuovaOperazione();
        }

        function nuovaOperazione() {
            if (gameOver) {
                inizializzaGioco();
                return;
            }
            
            verificaEseguita = false;
            haSbagliatoQuestaOperazione = false;
            aiutiUtilizzatiOperazioneCorrente = 0; // Reset aiuti per la nuova operazione
            nascondiMessaggio();
            
            if (modalitaGioco === 'interi') {
                // Genera numeri con 2-5 cifre
                const cifre = Math.floor(Math.random() * 4) + 2; // 2-5 cifre
                numeroCifreOperazioneCorrente = cifre;
                
                // Imposta il punteggio base in base al numero di cifre
                punteggioBaseOperazioneCorrente = cifre; // 2, 3, 4 o 5 punti max
                
                // Genera due numeri casuali
                numero1 = generaNumeroCasuale(cifre);
                numero2 = generaNumeroCasuale(cifre);
                
                // Calcola il risultato
                risultatoCorretto = numero1 + numero2;
                
                // Assicurati che il risultato abbia al massimo 6 cifre (5+1 per riporto finale)
                const cifreRisultato = risultatoCorretto.toString().length;
                if (cifreRisultato > 6) {
                    // Se troppo grande, riduci il secondo numero
                    const differenza = risultatoCorretto - Math.pow(10, 6);
                    numero2 = Math.max(1, numero2 - differenza - 1);
                    risultatoCorretto = numero1 + numero2;
                }
                
            } else {
                // Numeri decimali - consideriamo 3 cifre (es: 12,34 ha 2 cifre intere + 2 decimali)
                numeroCifreOperazioneCorrente = 3; // Consideriamo un livello medio
                punteggioBaseOperazioneCorrente = 3; // 3 punti max per i decimali
                
                numero1 = generaNumeroDecimale();
                numero2 = generaNumeroDecimale();
                
                if (numero1 > 999.99) numero1 = numero1 % 1000;
                if (numero2 > 999.99) numero2 = numero2 % 1000;
                
                risultatoCorretto = Math.round((numero1 + numero2) * 100) / 100;
            }
            
            preparaNumeriPerColonna();
            
            // Inizia dall'ultima colonna (pi√π a destra)
            colonnaAttiva = numCifreTotali - 1;
            modalitaRiporto = false;
            
            aggiornaColonna();
            document.getElementById("bottone-verifica").disabled = false;
            
            // Aggiorna l'indicatore degli aiuti
            aggiornaUI();
        }

        function preparaNumeriPerColonna() {
            let str1, str2, strRisultato;
            
            if (modalitaGioco === 'interi') {
                str1 = numero1.toString();
                str2 = numero2.toString();
                strRisultato = risultatoCorretto.toString();
                
                // Calcola la lunghezza massima tra tutti e tre i numeri
                const maxLength = Math.max(str1.length, str2.length, strRisultato.length);
                
                // Usa la lunghezza massima per tutte le cifre
                str1 = str1.padStart(maxLength, '0');
                str2 = str2.padStart(maxLength, '0');
                strRisultato = strRisultato.padStart(maxLength, '0');
                
                numCifreTotali = maxLength;
                posizioneVirgola = -1;
                
                cifreNumero1 = str1.split('');
                cifreNumero2 = str2.split('');
                cifreRisultato = new Array(numCifreTotali).fill("");
                cifreRiporto = new Array(numCifreTotali).fill("");
                risultatiCorretti = new Array(numCifreTotali).fill(0);
                riportiCorretti = new Array(numCifreTotali).fill(0);
                
                calcolaRisultatiCorrettiInteri();
            } else {
                str1 = numero1.toFixed(2);
                str2 = numero2.toFixed(2);
                strRisultato = risultatoCorretto.toFixed(2);
                
                const parte1 = str1.replace('.', '');
                const parte2 = str2.replace('.', '');
                const parteRis = strRisultato.replace('.', '');
                
                const maxLength = Math.max(parte1.length, parte2.length, parteRis.length);
                numCifreTotali = maxLength + 1; // +1 per la virgola
                posizioneVirgola = maxLength - 2; // Posizione della virgola
                
                cifreNumero1 = new Array(numCifreTotali).fill("");
                cifreNumero2 = new Array(numCifreTotali).fill("");
                cifreRisultato = new Array(numCifreTotali).fill("");
                cifreRiporto = new Array(numCifreTotali).fill("");
                risultatiCorretti = new Array(numCifreTotali).fill(0);
                riportiCorretti = new Array(numCifreTotali).fill(0);
                
                let idx = 0;
                for (let i = 0; i < numCifreTotali; i++) {
                    if (i === posizioneVirgola) {
                        cifreNumero1[i] = ",";
                        cifreNumero2[i] = ",";
                        risultatiCorretti[i] = ",";
                    } else {
                        cifreNumero1[i] = parte1[idx] || "0";
                        cifreNumero2[i] = parte2[idx] || "0";
                        idx++;
                    }
                }
                
                calcolaRisultatiCorrettiDecimali();
            }
        }

        function calcolaRisultatiCorrettiInteri() {
            let riporto = 0;
            
            for (let i = numCifreTotali - 1; i >= 0; i--) {
                const cifra1 = parseInt(cifreNumero1[i]) || 0;
                const cifra2 = parseInt(cifreNumero2[i]) || 0;
                const somma = cifra1 + cifra2 + riporto;
                
                risultatiCorretti[i] = somma % 10;
                riporto = Math.floor(somma / 10);
                
                if (i > 0) {
                    riportiCorretti[i-1] = riporto;
                }
            }
            
            // Se c'√® un riporto finale (oltre la colonna pi√π a sinistra),
            // aggiungi una colonna extra
            if (riporto > 0) {
                // Aggiungi una colonna a sinistra per il riporto finale
                cifreNumero1.unshift("0");
                cifreNumero2.unshift("0");
                cifreRisultato.unshift("");
                cifreRiporto.unshift("");
                risultatiCorretti.unshift(riporto);
                riportiCorretti.unshift(0);
                numCifreTotali++;
            }
        }

        function calcolaRisultatiCorrettiDecimali() {
            let riporto = 0;
            
            for (let i = numCifreTotali - 1; i >= 0; i--) {
                if (cifreNumero1[i] === ",") {
                    risultatiCorretti[i] = ",";
                    continue;
                }
                
                const cifra1 = parseInt(cifreNumero1[i]) || 0;
                const cifra2 = parseInt(cifreNumero2[i]) || 0;
                const somma = cifra1 + cifra2 + riporto;
                
                risultatiCorretti[i] = somma % 10;
                riporto = Math.floor(somma / 10);
                
                if (i > 0) {
                    let sinistra = i - 1;
                    while (sinistra >= 0 && cifreNumero1[sinistra] === ",") {
                        sinistra--;
                    }
                    if (sinistra >= 0) {
                        riportiCorretti[sinistra] = riporto;
                    }
                }
            }
        }

        // VISUALIZZAZIONE
        function aggiornaUI() {
            document.getElementById("punteggio").textContent = punteggio;
            document.getElementById("vite").textContent = vite;
            document.getElementById("contatore-consecutive").textContent = operazioniCorretteConsecutive;
            document.getElementById("contatore-aiuti").textContent = aiutiUtilizzatiOperazioneCorrente;
            
            // Mostra/nascondi l'indicatore di risposte consecutive
            const indicatoreConsecutive = document.getElementById("risposte-consecutive");
            if (operazioniCorretteConsecutive > 0) {
                indicatoreConsecutive.style.display = "flex";
            } else {
                indicatoreConsecutive.style.display = "none";
            }
            
            // Mostra/nascondi l'indicatore degli aiuti
            const indicatoreAiuti = document.getElementById("aiuti-utilizzati");
            if (aiutiUtilizzatiOperazioneCorrente > 0) {
                indicatoreAiuti.style.display = "flex";
            } else {
                indicatoreAiuti.style.display = "none";
            }
            
            // Aggiorna il testo del bottone aiuto
            document.getElementById("bottone-aiuto").innerHTML = `üß† Aiuto (-2 punti)`;
        }

        function aggiornaColonna() {
            const colonnaContainer = document.getElementById("colonna-container");
            colonnaContainer.innerHTML = "";
            
            // Riga riporti
            const rigaRiporti = document.createElement("div");
            rigaRiporti.className = "riga-colonna riga-riporti";
            
            // Riga primo numero
            const rigaNumero1 = document.createElement("div");
            rigaNumero1.className = "riga-colonna";
            
            // Riga secondo numero
            const rigaNumero2 = document.createElement("div");
            rigaNumero2.className = "riga-colonna";
            rigaNumero2.innerHTML = '<div class="spazio-segno">+</div>';
            
            // Linea divisione (NERA)
            const linea = document.createElement("div");
            linea.className = "linea-divisione";
            
            // Riga risultato
            const rigaRisultato = document.createElement("div");
            rigaRisultato.className = "riga-colonna";
            
            for (let i = 0; i < numCifreTotali; i++) {
                // RIPORTI
                if (i === numCifreTotali - 1) {
                    // Ultima colonna (unit√†) non ha riporto a destra
                    rigaRiporti.innerHTML += '<div class="cella-riporto" style="visibility: hidden;"></div>';
                } else if (modalitaGioco === 'decimali' && i === posizioneVirgola) {
                    // Posizione della virgola per decimali
                    rigaRiporti.innerHTML += '<div class="cella-riporto" style="visibility: hidden;"></div>';
                } else {
                    let valoreRiporto = "";
                    let isAttivo = false;
                    
                    if (cifreRiporto[i] !== "") {
                        valoreRiporto = cifreRiporto[i];
                        isAttivo = (colonnaAttiva === i && modalitaRiporto);
                    }
                    
                    rigaRiporti.innerHTML += 
                        `<div class="cella-riporto ${isAttivo ? 'attivo' : ''}" 
                              onclick="selezionaRiporto(${i})">
                            ${valoreRiporto}
                         </div>`;
                }
                
                // Primo numero
                if (modalitaGioco === 'decimali' && i === posizioneVirgola) {
                    rigaNumero1.innerHTML += `<div class="cella-virgola">,</div>`;
                } else {
                    rigaNumero1.innerHTML += `<div class="cella-numero">${cifreNumero1[i]}</div>`;
                }
                
                // Secondo numero
                if (modalitaGioco === 'decimali' && i === posizioneVirgola) {
                    rigaNumero2.innerHTML += `<div class="cella-virgola">,</div>`;
                } else {
                    rigaNumero2.innerHTML += `<div class="cella-numero">${cifreNumero2[i]}</div>`;
                }
                
                // Risultato
                const isAttiva = colonnaAttiva === i && !modalitaRiporto;
                
                if (modalitaGioco === 'decimali' && i === posizioneVirgola) {
                    rigaRisultato.innerHTML += `<div class="cella-virgola">,</div>`;
                } else {
                    rigaRisultato.innerHTML += 
                        `<div class="cella-risultato ${isAttiva ? 'cella-evidenziata' : ''}" 
                              onclick="selezionaColonna(${i})">
                            ${cifreRisultato[i] || ""}
                         </div>`;
                }
            }
            
            // Aggiungi tutte le righe al container
            colonnaContainer.appendChild(rigaRiporti);
            colonnaContainer.appendChild(rigaNumero1);
            colonnaContainer.appendChild(rigaNumero2);
            colonnaContainer.appendChild(linea);
            colonnaContainer.appendChild(rigaRisultato);
            
            // Regola la lunghezza della linea nera in base al numero di cifre
            const lineaDiv = document.querySelector('.linea-divisione');
            const larghezzaLinea = (numCifreTotali * 35) + ((numCifreTotali - 1) * 5);
            lineaDiv.style.width = `${larghezzaLinea}px`;
        }

        function creaTastiera() {
            const tastiera = document.getElementById("tastiera-numerica");
            tastiera.innerHTML = "";
            
            for (let i = 0; i <= 9; i++) {
                const tasto = document.createElement("button");
                tasto.className = "tasto-numero";
                tasto.textContent = i;
                tasto.onclick = () => inserisciCifra(i);
                tastiera.appendChild(tasto);
            }
            
            const tastoCancella = document.createElement("button");
            tastoCancella.className = "tasto-numero tasto-cancella";
            tastoCancella.textContent = "‚å´";
            tastoCancella.onclick = cancellaCifra;
            tastiera.appendChild(tastoCancella);
        }

        // FUNZIONE PER MOSTRARE MESSAGGI
        function mostraMessaggio(testo, tipo) {
            const messaggioDiv = document.getElementById("messaggio-verifica");
            messaggioDiv.textContent = testo;
            messaggioDiv.className = "messaggio-verifica mostra";
            
            if (tipo === "corretto") {
                messaggioDiv.classList.add("messaggio-corretto");
                messaggioDiv.classList.remove("messaggio-errato", "messaggio-info", "messaggio-game-over");
            } else if (tipo === "errato") {
                messaggioDiv.classList.add("messaggio-errato");
                messaggioDiv.classList.remove("messaggio-corretto", "messaggio-info", "messaggio-game-over");
            } else if (tipo === "game-over") {
                messaggioDiv.classList.add("messaggio-game-over");
                messaggioDiv.classList.remove("messaggio-corretto", "messaggio-errato", "messaggio-info");
            } else {
                messaggioDiv.classList.add("messaggio-info");
                messaggioDiv.classList.remove("messaggio-corretto", "messaggio-errato", "messaggio-game-over");
            }
        }

        function nascondiMessaggio() {
            const messaggioDiv = document.getElementById("messaggio-verifica");
            messaggioDiv.classList.remove("mostra");
            setTimeout(() => {
                messaggioDiv.textContent = "";
                messaggioDiv.className = "messaggio-verifica";
            }, 300);
        }

        // FUNZIONE PER CONTROLLARE SE L'OPERAZIONE √à CORRETTA
        function controllaSeCorretto() {
            if (modalitaGioco === 'interi') {
                calcolaRisultatiCorrettiInteri();
            } else {
                calcolaRisultatiCorrettiDecimali();
            }
            
            // Controlla se l'operazione √® corretta
            let tuttoCorretto = true;
            for (let i = 0; i < numCifreTotali; i++) {
                if (modalitaGioco === 'decimali' && i === posizioneVirgola) continue;
                
                const risultatoUtente = parseInt(cifreRisultato[i]) || 0;
                const risultatoCorrettoColonna = risultatiCorretti[i];
                
                if (risultatoUtente !== risultatoCorrettoColonna) {
                    tuttoCorretto = false;
                }
            }
            
            // Controlla i riporti
            for (let i = 0; i < numCifreTotali; i++) {
                if (modalitaGioco === 'decimali' && i === posizioneVirgola) continue;
                if (i === numCifreTotali - 1) continue;
                
                const riportoUtente = parseInt(cifreRiporto[i]) || 0;
                const riportoCorretto = riportiCorretti[i] || 0;
                
                if (riportoCorretto === 1 && riportoUtente !== riportoCorretto) {
                    tuttoCorretto = false;
                }
            }
            
            return tuttoCorretto;
        }

        // LOGICA DI GIOCO
        function selezionaColonna(indice) {
            if (gameOver || modalitaGioco === 'decimali' && indice === posizioneVirgola) return;
            
            colonnaAttiva = indice;
            modalitaRiporto = false;
            aggiornaColonna();
        }

        function selezionaRiporto(indice) {
            if (gameOver || indice === numCifreTotali - 1) return;
            if (modalitaGioco === 'decimali' && indice === posizioneVirgola) return;
            
            colonnaAttiva = indice;
            modalitaRiporto = true;
            aggiornaColonna();
        }

        function inserisciCifra(cifra) {
            if (gameOver || colonnaAttiva < 0 || colonnaAttiva >= numCifreTotali) return;
            
            if (modalitaGioco === 'decimali' && colonnaAttiva === posizioneVirgola) return;
            
            if (modalitaRiporto) {
                // Inserimento riporto
                if (cifra === 0 || cifra === 1) {
                    cifreRiporto[colonnaAttiva] = cifra.toString();
                    
                    // Dopo il riporto, resta sulla stessa colonna per il risultato
                    modalitaRiporto = false;
                } else {
                    mostraMessaggio("Il riporto pu√≤ essere solo 0 o 1", "errato");
                    return;
                }
            } else {
                // Inserimento cifra risultato
                if (cifra >= 0 && cifra <= 9) {
                    cifreRisultato[colonnaAttiva] = cifra.toString();
                    
                    // Calcola se c'√® bisogno di riporto
                    const cifra1 = parseInt(cifreNumero1[colonnaAttiva]) || 0;
                    const cifra2 = parseInt(cifreNumero2[colonnaAttiva]) || 0;
                    const riportoIn = parseInt(cifreRiporto[colonnaAttiva]) || 0;
                    const somma = cifra1 + cifra2 + riportoIn;
                    
                    const nuovoRiporto = Math.floor(somma / 10);
                    
                    // Vai alla colonna precedente (a sinistra)
                    let precedente = colonnaAttiva - 1;
                    
                    if (modalitaGioco === 'decimali') {
                        while (precedente >= 0 && precedente === posizioneVirgola) {
                            precedente--;
                        }
                    }
                    
                    if (precedente >= 0) {
                        colonnaAttiva = precedente;
                        
                        if (nuovoRiporto > 0) {
                            modalitaRiporto = true;
                        }
                    } else {
                        // Ultima colonna completata
                        mostraMessaggio("Operazione completata! Premi VERIFICA", "info");
                    }
                } else {
                    mostraMessaggio("Inserisci una cifra da 0 a 9", "errato");
                    return;
                }
            }
            
            aggiornaColonna();
        }

        function cancellaCifra() {
            if (gameOver || colonnaAttiva < 0 || colonnaAttiva >= numCifreTotali) return;
            if (modalitaGioco === 'decimali' && colonnaAttiva === posizioneVirgola) return;
            
            if (modalitaRiporto) {
                cifreRiporto[colonnaAttiva] = "";
            } else {
                cifreRisultato[colonnaAttiva] = "";
            }
            
            aggiornaColonna();
        }

        function mostraAiuto() {
            if (gameOver) {
                mostraMessaggio("Game Over! Clicca 'Nuova' per ricominciare", "errato");
                return;
            }
            
            // Controlla se ha abbastanza punti (non pu√≤ andare troppo in negativo PRIMA dell'operazione)
            // Permettiamo comunque l'aiuto, ma segnaliamo che potrebbe finire con 0 punti
            if (punteggio <= 0 && aiutiUtilizzatiOperazioneCorrente >= 1) {
                mostraMessaggio("Attenzione! Potresti finire con 0 punti per questa operazione!", "errato");
                return;
            }
            
            // Incrementa contatore aiuti
            aiutiUtilizzatiOperazioneCorrente++;
            
            // Calcola quanti punti verrebbero sottratti
            const puntiDaSottrarre = 2;
            
            // Mostra il messaggio di aiuto
            if (modalitaRiporto) {
                const riportoCorretto = riportiCorretti[colonnaAttiva] || 0;
                if (riportoCorretto === 1) {
                    mostraMessaggio(`Aiuto: riporto = 1 (-${puntiDaSottrarre} punti, totale aiuti: ${aiutiUtilizzatiOperazioneCorrente})`, "info");
                } else {
                    mostraMessaggio(`Aiuto: nessun riporto (-${puntiDaSottrarre} punti, totale aiuti: ${aiutiUtilizzatiOperazioneCorrente})`, "info");
                }
            } else {
                const risultatoCorrettoColonna = risultatiCorretti[colonnaAttiva];
                mostraMessaggio(`Aiuto: risultato = ${risultatoCorrettoColonna} (-${puntiDaSottrarre} punti, totale aiuti: ${aiutiUtilizzatiOperazioneCorrente})`, "info");
            }
            
            // Aggiorna UI
            aggiornaUI();
        }

        function verificaOperazione() {
            if (gameOver) return;
            
            // Controlla se tutte le caselle sono state riempite
            let tuttePiene = true;
            for (let i = 0; i < numCifreTotali; i++) {
                if (modalitaGioco === 'decimali' && i === posizioneVirgola) continue;
                
                if (cifreRisultato[i] === "" || cifreRisultato[i] === undefined) {
                    tuttePiene = false;
                    break;
                }
            }
            
            if (!tuttePiene) {
                mostraMessaggio("Completa tutte le caselle prima di verificare!", "errato");
                return;
            }
            
            // Controlla se l'operazione √® corretta
            const tuttoCorretto = controllaSeCorretto();
            
            if (tuttoCorretto) {
                // CALCOLA IL PUNTEGGIO FINALE PER QUESTA OPERAZIONE
                // Punteggio base (dipende dal numero di cifre) - (aiuti * 2)
                const puntiGuadagnati = punteggioBaseOperazioneCorrente - (aiutiUtilizzatiOperazioneCorrente * 2);
                
                // Il punteggio NON pu√≤ essere negativo per questa operazione
                const puntiFinali = Math.max(0, puntiGuadagnati);
                
                // Aggiungi al punteggio totale
                punteggio += puntiFinali;
                operazioniCorretteConsecutive++;
                
                // Prepara il messaggio
                let messaggioPunti = `‚úì Corretto!`;
                if (puntiFinali > 0) {
                    messaggioPunti += ` +${puntiFinali} punti`;
                } else {
                    messaggioPunti += ` 0 punti (troppi aiuti!)`;
                }
                
                if (modalitaGioco === 'interi') {
                    messaggioPunti += ` (${numeroCifreOperazioneCorrente} cifre, ${aiutiUtilizzatiOperazioneCorrente} aiuti)`;
                } else {
                    messaggioPunti += ` (decimali, ${aiutiUtilizzatiOperazioneCorrente} aiuti)`;
                }
                
                // RECUPERA UNA VITA OGNI 5 RISPOSTE CONSECUTIVE CORRETTE
                if (operazioniCorretteConsecutive >= 5 && vite < 3) {
                    vite++;
                    operazioniCorretteConsecutive = 0; // Reset contatore dopo aver dato la vita
                    messaggioPunti += ` üéâ 5 risposte consecutive! Vita recuperata!`;
                }
                
                mostraMessaggio(messaggioPunti, "corretto");
                setTimeout(nuovaOperazione, 2000);
                verificaEseguita = true;
            } else {
                // Reset contatore risposte consecutive se sbaglia
                operazioniCorretteConsecutive = 0;
                
                // Se √® la prima volta che sbaglia questa operazione
                if (!haSbagliatoQuestaOperazione) {
                    vite--;
                    haSbagliatoQuestaOperazione = true;
                    verificaEseguita = false;
                    
                    if (vite <= 0) {
                        gameOver = true;
                        mostraMessaggio(`GAME OVER! Punteggio finale: ${punteggio}. Clicca "Nuova" per ricominciare`, "game-over");
                        document.getElementById("bottone-verifica").disabled = true;
                        document.getElementById("bottone-aiuto").disabled = true;
                    } else {
                        mostraMessaggio(`‚úó Errore! Vite rimaste: ${vite}. Correggi e riprova`, "errato");
                    }
                } else {
                    mostraMessaggio(`Ci sono ancora errori. Correggi e riprova`, "errato");
                }
            }
            
            aggiornaUI();
        }

        // FUNZIONI PER LA MODALE ISTRUZIONI
        function mostraIstruzioni() {
            document.getElementById('modal-overlay').style.display = 'flex';
        }
        
        function nascondiIstruzioni(event) {
            if (!event || event.target.classList.contains('modal-overlay') || event.target.classList.contains('close-modal')) {
                document.getElementById('modal-overlay').style.display = 'none';
            }
        }
    </script>
</body>
</html>
