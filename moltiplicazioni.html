<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gioco delle Moltiplicazioni in Colonna v2.1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1000px;
            width: 100%;
            max-height: 98vh;
            overflow-y: auto;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1.6em;
        }

        .score-board {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
            padding: 8px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            color: white;
        }

        .score-item {
            text-align: center;
        }

        .score-label {
            font-size: 0.75em;
            opacity: 0.9;
        }

        .score-value {
            font-size: 1.4em;
            font-weight: bold;
        }

        .multiplication-area {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            overflow-x: auto;
        }

        .operation {
            font-family: 'Courier New', monospace;
            font-size: 1.8em;
            line-height: 1.3;
            position: relative;
        }

        .number-row {
            display: flex;
            align-items: center;
            margin: 3px 0;
            position: relative;
            justify-content: flex-end;
        }

        .operator {
            width: 40px;
            text-align: center;
            color: #667eea;
            font-weight: bold;
            font-size: 1.5em;
        }

        .number-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .digit-row {
            display: flex;
            justify-content: flex-end;
            gap: 6px;
            margin-bottom: 3px;
        }

        .digit-cell {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .digit {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }

        .carry-input {
            width: 35px;
            height: 35px;
            text-align: center;
            font-size: 0.95em;
            border: 2px solid #f5576c;
            border-radius: 5px;
            background: #fff;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .carry-input:focus {
            outline: none;
            border-color: #ff1744;
            box-shadow: 0 0 8px rgba(255, 23, 68, 0.3);
            background-color: #fff8e1;
        }

        .carry-input.correct {
            background: #d4edda;
            border-color: #28a745;
        }

        .carry-input.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .empty-cell {
            width: 45px;
            height: 45px;
            background: #e9ecef;
            border-radius: 8px;
            border: 2px dashed #adb5bd;
        }

        .phase-indicator {
            text-align: center;
            padding: 5px 8px;
            margin: 5px 0;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: bold;
            color: #333;
            line-height: 1.2;
        }

        .line {
            border-top: 3px solid #667eea;
            margin: 5px 0;
        }

        .input-row {
            display: flex;
            justify-content: flex-end;
            gap: 6px;
            margin: 5px 0;
            align-items: center;
        }

        .input-digit {
            width: 45px;
            height: 45px;
            text-align: center;
            font-size: 1.4em;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .input-digit:focus {
            outline: none;
            border-color: #f5576c;
            box-shadow: 0 0 10px rgba(245, 87, 108, 0.3);
        }

        .input-digit.correct {
            background: #d4edda;
            border-color: #28a745;
        }

        .input-digit.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
            animation: shake 0.3s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        button {
            padding: 10px 20px;
            font-size: 1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-check {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-new {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-hint {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .message {
            text-align: center;
            padding: 8px;
            margin-top: 10px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
            min-height: 40px;
        }

        .message.show {
            opacity: 1;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
        }

        .message.points {
            background: #fff3cd;
            color: #856404;
        }

        .timer {
            text-align: center;
            font-size: 1.2em;
            color: #667eea;
            margin: 5px 0;
        }

        .partial-label {
            font-size: 0.7em;
            color: #666;
            margin-right: 8px;
            min-width: 65px;
            text-align: right;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 10px;
            padding: 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85em;
            line-height: 1.4;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .tooltiptext strong {
            color: #f5576c;
            display: block;
            margin-bottom: 5px;
        }
        
        .tooltiptext ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .tooltiptext li {
            margin: 4px 0;
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            .digit-cell, .input-digit, .empty-cell {
                width: 35px;
                height: 35px;
            }
            
            .input-digit {
                font-size: 1.2em;
            }
            
            .carry-input {
                width: 30px;
                height: 30px;
                font-size: 0.9em;
            }
            
            .partial-label {
                font-size: 0.7em;
                min-width: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Moltiplicazioni in Colonna üéØ</h1>
        
        <div class="score-board">
            <div class="score-item">
                <div class="score-label">Punteggio</div>
                <div class="score-value" id="score">0</div>
            </div>
            <div class="score-item">
                <div class="score-label">Operazioni</div>
                <div class="score-value" id="operations">0</div>
            </div>
            <div class="score-item">
                <div class="score-label tooltip">
                    Streak üî•
                    <span class="tooltiptext">
                        <strong>Cos'√® lo Streak?</strong>
                        Lo Streak indica quante moltiplicazioni hai risolto correttamente di seguito, senza errori.
                        <ul>
                            <li>‚úÖ Risolvi correttamente ‚Üí Streak +1</li>
                            <li>‚ùå Sbagli ‚Üí Streak torna a 0</li>
                        </ul>
                        <strong>üéÅ Bonus Punti:</strong>
                        Con Streak ‚â• 3 ricevi punti extra!<br>
                        (Streak √ó 10 punti bonus)
                    </span>
                </div>
                <div class="score-value" id="streak">0</div>
            </div>
        </div>

        <div class="timer" id="timer">Tempo: 0s</div>

        <div class="multiplication-area">
            <div class="operation" id="operation"></div>
        </div>

        <div class="button-group">
            <button class="btn-check" id="checkBtn">Controlla</button>
            <button class="btn-new" id="newBtn">Nuova Moltiplicazione</button>
            <button class="btn-hint" id="hintBtn">Aiuto</button>
        </div>

        <div class="message" id="message"></div>
    </div>

    <script>
        let currentNum1, currentNum2;
        let partialProducts = [];
        let finalResult;
        let startTime;
        let timerInterval;
        let score = 0;
        let operations = 0;
        let streak = 0;
        let expectedPartialResults = [];
        let totalColumns = 0;

        function generateNumber(digits, decimals) {
            if (decimals > 0) {
                digits = 2;
            } else {
                digits = Math.min(Math.max(digits, 2), 3);
            }
            
            let num;
            if (digits === 2) {
                num = Math.floor(Math.random() * 90) + 10;
            } else if (digits === 3) {
                num = Math.floor(Math.random() * 900) + 100;
            } else {
                num = Math.floor(Math.random() * 90) + 10;
            }
            
            if (decimals > 0) {
                const maxDecimal = Math.pow(10, decimals);
                const decimalPart = Math.floor(Math.random() * maxDecimal);
                return parseFloat(num + '.' + decimalPart.toString().padStart(decimals, '0'));
            }
            
            return num;
        }

        function formatNumber(num) {
            return num.toString().replace('.', ',');
        }

        function getDigits(num) {
            const str = num.toString();
            const parts = str.split('.');
            let result = [];
            
            for (let i = 0; i < parts[0].length; i++) {
                result.push(parts[0][i]);
            }
            
            if (parts.length > 1) {
                result.push('.');
                for (let i = 0; i < parts[1].length; i++) {
                    result.push(parts[1][i]);
                }
            }
            
            return result;
        }

        function calculatePartialProducts(num1, num2) {
            const str1 = num1.toString().replace('.', '');
            const str2 = num2.toString().replace('.', '');
            const decimals1 = num1.toString().includes('.') ? num1.toString().split('.')[1].length : 0;
            const decimals2 = num2.toString().includes('.') ? num2.toString().split('.')[1].length : 0;
            
            const partials = [];
            const expectedResults = [];
            
            for (let i = str2.length - 1; i >= 0; i--) {
                const digit2 = parseInt(str2[i]);
                const position = str2.length - 1 - i;
                
                let carry = 0;
                const resultDigits = [];
                
                for (let j = str1.length - 1; j >= 0; j--) {
                    const digit1 = parseInt(str1[j]);
                    const product = digit1 * digit2 + carry;
                    const currentDigit = product % 10;
                    carry = Math.floor(product / 10);
                    
                    resultDigits.unshift(currentDigit);
                }
                
                if (carry > 0) {
                    resultDigits.unshift(carry);
                }
                
                expectedResults.push(resultDigits);
                const partialValue = parseInt(str1) * digit2 * Math.pow(10, position);
                partials.push(partialValue);
            }
            
            const finalResultValue = num1 * num2;
            const totalDecimals = decimals1 + decimals2;
            const finalResultStr = finalResultValue.toFixed(totalDecimals).replace('.', '');
            totalColumns = finalResultStr.length;
            
            for (let i = 0; i < expectedResults.length; i++) {
                const lengthWithOffset = expectedResults[i].length + i;
                if (lengthWithOffset > totalColumns) {
                    totalColumns = lengthWithOffset;
                }
            }
            
            expectedPartialResults = expectedResults;
            finalResult = parseFloat(finalResultValue.toFixed(totalDecimals));
            
            return { partials, finalResult };
        }

        function createCell(content, type = 'digit') {
            if (type === 'digit') {
                return `<div class="digit-cell"><div class="digit">${content}</div></div>`;
            } else if (type === 'empty') {
                return `<div class="digit-cell"><div class="empty-cell"></div></div>`;
            }
            return '';
        }

        function newMultiplication() {
            const useDecimals = Math.random() < 0.5;
            
            if (useDecimals) {
                const random = Math.random();
                
                if (random < 0.33) {
                    const dec1 = Math.floor(Math.random() * 2) + 1;
                    const dec2 = Math.floor(Math.random() * 2) + 1;
                    currentNum1 = generateNumber(2, dec1);
                    currentNum2 = generateNumber(2, dec2);
                } else if (random < 0.66) {
                    const dec = Math.floor(Math.random() * 2) + 1;
                    currentNum1 = generateNumber(2, dec);
                    currentNum2 = generateNumber(2, 0);
                } else {
                    const dec = Math.floor(Math.random() * 2) + 1;
                    currentNum1 = generateNumber(2, 0);
                    currentNum2 = generateNumber(2, dec);
                }
            } else {
                const digits1 = Math.random() < 0.5 ? 2 : 3;
                const digits2 = Math.random() < 0.5 ? 2 : 3;
                currentNum1 = generateNumber(digits1, 0);
                currentNum2 = generateNumber(digits2, 0);
            }
            
            const result = calculatePartialProducts(currentNum1, currentNum2);
            partialProducts = result.partials;
            finalResult = result.finalResult;
            
            renderOperation();
            startTimer();
            showMessage('');
        }

        function renderOperation() {
            const str1 = currentNum1.toString().replace('.', '');
            const str2 = currentNum2.toString().replace('.', '');
            const digits1 = getDigits(currentNum1);
            const digits2 = getDigits(currentNum2);
            const decimals1 = currentNum1.toString().includes('.') ? currentNum1.toString().split('.')[1].length : 0;
            const decimals2 = currentNum2.toString().includes('.') ? currentNum2.toString().split('.')[1].length : 0;
            const totalDecimals = decimals1 + decimals2;
            
            let html = '';
            
            html += '<div class="phase-indicator" id="phaseIndicator">Inizia moltiplicando per la cifra delle unit√†!</div>';
            
            // Riga per i riporti sopra il primo numero
            html += '<div class="number-row">';
            html += '<div class="operator"></div>';
            html += '<div class="number-container">';
            html += '<div class="digit-row">';
            
            for (let i = 0; i < totalColumns - str1.length; i++) {
                html += createCell('', 'empty');
            }
            
            for (let i = 0; i < str1.length; i++) {
                html += `<div class="digit-cell">`;
                html += `<input type="text" maxlength="1" class="carry-input" data-carry-type="mult" data-carry-col="${i}" placeholder="">`;
                html += `</div>`;
            }
            html += '</div>';
            
            html += '<div class="digit-row">';
            for (let i = 0; i < totalColumns - str1.length; i++) {
                html += createCell('', 'empty');
            }
            for (let d of digits1) {
                html += createCell(d === '.' ? ',' : d, 'digit');
            }
            html += '</div>';
            html += '</div></div>';
            
            html += '<div class="number-row">';
            html += '<div class="operator">√ó</div>';
            html += '<div class="number-container">';
            html += '<div class="digit-row">';
            
            const emptyCellsForNum2 = totalColumns - str2.length;
            for (let i = 0; i < emptyCellsForNum2; i++) {
                html += createCell('', 'empty');
            }
            
            for (let d of digits2) {
                html += createCell(d === '.' ? ',' : d, 'digit');
            }
            html += '</div>';
            html += '</div></div>';
            
            html += '<div class="line"></div>';
            
            // Prodotti parziali con allineamento corretto
            for (let row = 0; row < str2.length; row++) {
                const expectedDigits = expectedPartialResults[row];
                const offset = row;
                
                html += '<div class="input-row">';
                html += `<span class="partial-label">√ó ${str2[str2.length - 1 - row]}:</span>`;
                
                // Celle vuote a sinistra
                const emptyCellsLeft = totalColumns - expectedDigits.length - offset;
                for (let i = 0; i < emptyCellsLeft; i++) {
                    html += createCell('', 'empty');
                }
                
                // Cifre
                for (let i = 0; i < expectedDigits.length; i++) {
                    html += `<div class="digit-cell">`;
                    html += `<input type="text" maxlength="1" class="input-digit" data-row="${row}" data-col="${i}" inputmode="numeric">`;
                    html += `</div>`;
                }
                
                // Celle vuote a destra
                for (let i = 0; i < offset; i++) {
                    html += createCell('', 'empty');
                }
                
                html += '</div>';
            }
            
            html += '<div class="line"></div>';
            
            // Riga per i riporti della somma finale (se necessario)
            if (str2.length > 1) {
                html += '<div class="number-row">';
                html += '<div class="operator"></div>';
                html += '<div class="number-container">';
                html += '<div class="digit-row">';
                
                for (let i = 0; i < totalColumns; i++) {
                    html += `<div class="digit-cell">`;
                    if (i < totalColumns - 1) { // Non serve riporto sull'ultima cifra
                        html += `<input type="text" maxlength="1" class="carry-input" data-carry-type="sum" data-carry-col="${i}" placeholder="">`;
                    }
                    html += `</div>`;
                }
                html += '</div>';
                html += '</div></div>';
            }
            
            // Risultato finale con virgola se necessario
            html += '<div class="input-row">';
            html += `<span class="partial-label">Totale:</span>`;
            
            const finalResultStr = finalResult.toString();
            const finalParts = finalResultStr.split('.');
            const integerPart = finalParts[0];
            const decimalPart = finalParts[1] || '';
            
            // Celle vuote a sinistra per allineare
            const totalFinalDigits = integerPart.length + (decimalPart ? 1 + decimalPart.length : 0);
            const emptyCellsForResult = totalColumns - (integerPart.length + decimalPart.length);
            
            for (let i = 0; i < emptyCellsForResult; i++) {
                html += createCell('', 'empty');
            }
            
            // Parte intera
            for (let i = 0; i < integerPart.length; i++) {
                html += `<div class="digit-cell">`;
                html += `<input type="text" maxlength="1" class="input-digit" data-row="${str2.length}" data-col="${i}" data-type="integer" inputmode="numeric">`;
                html += `</div>`;
            }
            
            // Virgola se necessario
            if (totalDecimals > 0) {
                html += createCell(',', 'digit');
            }
            
            // Parte decimale
            if (decimalPart) {
                for (let i = 0; i < decimalPart.length; i++) {
                    html += `<div class="digit-cell">`;
                    html += `<input type="text" maxlength="1" class="input-digit" data-row="${str2.length}" data-col="${integerPart.length + i}" data-type="decimal" inputmode="numeric">`;
                    html += `</div>`;
                }
            }
            
            html += '</div>';
            
            document.getElementById('operation').innerHTML = html;
            
            setupEventListeners();
        }
        
        function setupEventListeners() {
            const inputs = document.querySelectorAll('.input-digit');
            
            inputs.forEach(input => {
                input.addEventListener('input', (e) => {
                    const value = e.target.value;
                    if (value && /[0-9]/.test(value)) {
                        updatePhaseIndicator();
                        const row = parseInt(input.dataset.row);
                        const col = parseInt(input.dataset.col);
                        
                        if (col > 0) {
                            const prevInput = document.querySelector(`[data-row="${row}"][data-col="${col - 1}"]`);
                            if (prevInput) {
                                prevInput.focus();
                            }
                        }
                    }
                });
            });
        }
        
        function updatePhaseIndicator() {
            const str2 = currentNum2.toString().replace('.', '');
            const inputs = document.querySelectorAll('.input-digit');
            
            let completedRows = 0;
            for (let i = 0; i < str2.length; i++) {
                const rowInputs = Array.from(inputs).filter(inp => 
                    parseInt(inp.dataset.row) === i
                );
                const allFilled = rowInputs.every(inp => inp.value && /[0-9]/.test(inp.value));
                if (allFilled) completedRows++;
                else break;
            }
            
            // Azzera i riporti delle moltiplicazioni quando si cambia riga
            const multCarries = document.querySelectorAll('[data-carry-type="mult"]');
            multCarries.forEach(carry => {
                carry.value = '';
                carry.classList.remove('correct', 'incorrect');
            });
            
            const indicator = document.getElementById('phaseIndicator');
            if (completedRows === 0) {
                indicator.textContent = `üìù Moltiplica ${formatNumber(currentNum1)} √ó ${str2[str2.length - 1]}`;
            } else if (completedRows < str2.length) {
                const digit = str2[str2.length - 1 - completedRows];
                indicator.textContent = `üìù Ora moltiplica ${formatNumber(currentNum1)} √ó ${digit}`;
            } else {
                indicator.textContent = '‚ûï Ora somma tutti i prodotti parziali!';
                indicator.style.color = 'white';
            }
        }

        function startTimer() {
            startTime = Date.now();
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').textContent = `Tempo: ${elapsed}s`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            return Math.floor((Date.now() - startTime) / 1000);
        }

        function checkAnswer() {
            const inputs = document.querySelectorAll('.input-digit');
            const str2 = currentNum2.toString().replace('.', '');
            const decimals1 = currentNum1.toString().includes('.') ? currentNum1.toString().split('.')[1].length : 0;
            const decimals2 = currentNum2.toString().includes('.') ? currentNum2.toString().split('.')[1].length : 0;
            const totalDecimals = decimals1 + decimals2;
            
            let allCorrect = true;
            let emptyFields = false;
            let partialCorrect = 0;
            
            // Verifica prodotti parziali
            for (let i = 0; i < str2.length; i++) {
                const rowInputs = Array.from(inputs).filter(inp => 
                    parseInt(inp.dataset.row) === i
                );
                
                const userDigits = [];
                rowInputs.forEach(inp => {
                    if (!inp.value) emptyFields = true;
                    else userDigits.push(inp.value);
                });
                
                if (!emptyFields) {
                    const expectedDigits = expectedPartialResults[i];
                    const isCorrect = JSON.stringify(userDigits) === JSON.stringify(expectedDigits.map(d => d.toString()));
                    
                    rowInputs.forEach((inp, idx) => {
                        const isDigitCorrect = userDigits[idx] === expectedDigits[idx].toString();
                        inp.classList.toggle('correct', isDigitCorrect);
                        inp.classList.toggle('incorrect', !isDigitCorrect);
                    });
                    
                    if (isCorrect) partialCorrect++;
                    else allCorrect = false;
                }
            }
            
            // Verifica risultato finale (con gestione della virgola)
            const finalInputs = Array.from(inputs).filter(inp => 
                parseInt(inp.dataset.row) === str2.length
            );
            
            const integerInputs = finalInputs.filter(inp => inp.dataset.type === 'integer' || !inp.dataset.type);
            const decimalInputs = finalInputs.filter(inp => inp.dataset.type === 'decimal');
            
            let userFinalStr = '';
            integerInputs.forEach(inp => {
                if (!inp.value) emptyFields = true;
                else userFinalStr += inp.value;
            });
            
            if (totalDecimals > 0) {
                userFinalStr += '.';
                decimalInputs.forEach(inp => {
                    if (!inp.value) emptyFields = true;
                    else userFinalStr += inp.value;
                });
            }
            
            const userFinal = parseFloat(userFinalStr) || 0;
            
            if (!emptyFields) {
                const finalCorrect = Math.abs(userFinal - finalResult) <= 0.001;
                
                finalInputs.forEach(inp => {
                    inp.classList.toggle('correct', finalCorrect);
                    inp.classList.toggle('incorrect', !finalCorrect);
                });
                
                if (!finalCorrect) allCorrect = false;
            }
            
            if (emptyFields) {
                showMessage('üìù Completa tutti i campi!', 'error');
                return;
            }
            
            const elapsed = stopTimer();
            operations++;
            document.getElementById('operations').textContent = operations;
            
            if (allCorrect) {
                let points = 100;
                if (elapsed < 30) points += 50;
                else if (elapsed < 60) points += 25;
                else if (elapsed < 90) points += 10;
                
                score += points;
                streak++;
                
                if (streak >= 3) {
                    const bonusPoints = streak * 10;
                    score += bonusPoints;
                    points += bonusPoints;
                }
                
                document.getElementById('score').textContent = score;
                document.getElementById('streak').textContent = streak;
                
                showMessage(`üéâ Perfetto! +${points} punti (${elapsed}s) üåü`, 'success');
                
                setTimeout(() => newMultiplication(), 2500);
            } else {
                streak = 0;
                document.getElementById('streak').textContent = streak;
                showMessage(`‚ùå ${partialCorrect}/${str2.length} corretti. Riprova! üí™`, 'error');
            }
        }

        function showHint() {
            const hint = `üí° Risultato: ${formatNumber(currentNum1)} √ó ${formatNumber(currentNum2)} = ${formatNumber(finalResult)}`;
            showMessage(hint, 'points');
        }

        function showMessage(text, type = '') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = 'message';
            if (type) messageEl.classList.add(type);
            if (text) messageEl.classList.add('show');
        }

        document.getElementById('checkBtn').addEventListener('click', checkAnswer);
        document.getElementById('newBtn').addEventListener('click', newMultiplication);
        document.getElementById('hintBtn').addEventListener('click', showHint);

        newMultiplication();
    </script>
</body>
</html>
